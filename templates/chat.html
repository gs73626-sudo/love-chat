<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æˆ‘ä»¬çš„å°ä¸–ç•Œ</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body { background:#f5f5f5; font-family:sans-serif; }
.msg { padding:8px 12px; margin:6px; border-radius:10px; max-width:65%; }
.ä½  { background:#d1f5d3; margin-left:auto; }
.å¥¹ { background:#f5d1e8; }
.time { font-size:12px; color:#666; }
img { max-width:200px; border-radius:6px; }
</style>
</head>

<body>
<h3 style="text-align:center;">ğŸ’¬ æˆ‘ä»¬çš„å°èŠå¤©</h3>

<div id="chat">
{% for m in messages %}
  <div class="msg {{ m.sender }}">
    <b>{{ m.sender }}</b> <span class="time">{{ m.time }}</span><br>
    {% if m.type == "text" %}
      {{ m.content }}
    {% else %}
      <img src="/{{ m.content }}">
    {% endif %}
  </div>
{% endfor %}
</div>

<hr>

<input id="text" placeholder="è¯´ç‚¹ä»€ä¹ˆ">
<input type="file" id="image">
<button onclick="sendText()">å‘é€</button>

<script>
const socket = io();
const user = "{{ user }}";

function sendText(){
  const text = document.getElementById("text").value;
  if(text){
    socket.emit("send_message", {
      sender: user,
      type: "text",
      content: text
    });
    document.getElementById("text").value = "";
  }
}

document.getElementById("image").onchange = function(){
  const file = this.files[0];
  const reader = new FileReader();
  reader.onload = function(){
    socket.emit("send_image", {
      sender: user,
      filename: file.name,
      filedata: new Uint8Array(reader.result)
    });
  };
  reader.readAsArrayBuffer(file);
};

socket.on("new_message", function(m){
  const div = document.createElement("div");
  div.className = "msg " + m.sender;
  div.innerHTML = `<b>${m.sender}</b> <span class="time">${m.time}</span><br>` +
    (m.type === "text" ? m.content : `<img src="/${m.content}">`);
  document.getElementById("chat").appendChild(div);
  window.scrollTo(0, document.body.scrollHeight);
});
</script>

</body>
</html>

