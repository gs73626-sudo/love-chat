<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="/static/style.css">
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<div id="chat"></div>

<form id="form">
<input id="msg" autocomplete="off">
<input type="file" id="img">
<button>发送</button>
</form>

<script>
const socket = io();
const user = "{{ user }}";

socket.on("history", msgs => {
  document.getElementById("chat").innerHTML = "";
  msgs.forEach(addMsg);
});

socket.on("new_message", addMsg);

function addMsg(m) {
  const d = document.createElement("div");
  d.className = "bubble " + (m.sender === user ? "me" : "her");
  d.innerHTML =
    (m.type === "text"
      ? m.content
      : `<img src="/${m.content}">`) +
    `<div class="time">${m.time}</div>`;
  chat.appendChild(d);
  window.scrollTo(0, document.body.scrollHeight);
}

form.onsubmit = e => {
  e.preventDefault();
  socket.emit("send_message", {type:"text", content:msg.value});
  msg.value="";
};

img.onchange = () => {
  const f = img.files[0];
  const r = new FileReader();
  r.onload = () => socket.emit("send_image",{name:f.name,data:r.result});
  r.readAsArrayBuffer(f);
};
</script>

</body>
</html>


